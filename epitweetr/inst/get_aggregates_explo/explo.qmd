---
title: "Untitled"
format: html
---


```{r}
library(epitweetr)
library(dplyr)
setup_config()
date_min <- substr(as.character(Sys.Date() - 10), 1, 10)
date_max <- substr(as.character(Sys.Date()), 1, 10)
```

```{r}
df <- tibble::tibble(epitweetr::search_tweets(topic = "covid-19"))
# voir parametre query: format Lucene avec OR/AND etc ...
df
```

# Exploration get_aggregates

## 1. country_counts

```{r, eval=FALSE}
country_counts <- get_aggregates("country_counts",
    filter = list(period = c(date_min, date_max)), cache = FALSE
) %>%
    as_tibble()
```

## 2. geolocated

```{r, eval=FALSE}
geolocated <- get_aggregates("geolocated",
    filter = list(period = c(date_min, date_max)), cache = FALSE
) %>%
    as_tibble()
```

## 3. tags

```{r, eval=FALSE}
tags <- get_aggregates("tags",
    filter = list(period = c(date_min, date_max)), cache = FALSE
) %>%
    as_tibble()
```

## 4. topwords

```{r, eval=FALSE}
topwords <- get_aggregates("topwords",
    filter = list(period = c(date_min, date_max)), cache = FALSE
) %>%
    as_tibble()
```

## 5. urls

```{r, eval=FALSE}
urls <- get_aggregates("urls",
    filter = list(period = c(date_min, date_max)), cache = FALSE
) %>%
    as_tibble()
```

## 6. tweets

```{r, eval=FALSE}
tweets <- get_aggregates("tweets",
    filter = list(period = c(date_min, date_max)), cache = FALSE
) %>%
    as_tibble()
```

```{r}
# saveRDS(
#     list(
#         country_counts = country_counts,
#         geolocated = geolocated,
#         tags = tags,
#         topwords = topwords,
#         urls = urls,
#         tweets = tweets
#     ),
#     file = file.path(
#         system.file("get_aggregates_explo", package = "epitweetr"),
#         "get_aggregates_sample.rds"
#     )
# )
```

```{r}
get_aggregates_sample <- readRDS(file.path(system.file("get_aggregates_explo", package = "epitweetr"), "get_aggregates_sample.rds"))
```

```{r}
View(get_aggregates_sample$country_counts)
```

# trend_line


```{r}
topic = "Measles"
countries = c(1)
date_type = "created_date"
date_min = "2025-08-01"
date_max = Sys.Date()

location_type = "tweet"
alpha = 0.025
alpha_outlier = 0.05
k_decay = 4
no_historic = 7
bonferroni_correction = FALSE
same_weekday_baseline = FALSE 

with_retweets = TRUE
setup_config()
trend_line(
    topic = topic,
    countries = countries,
    date_type = date_type,
    date_min = date_min,
    date_max = date_max,
    with_retweets = with_retweets,
    alpha = alpha,
    alpha_outlier = alpha_outlier,
    k_decay = k_decay,
    no_historic = no_historic,
    bonferroni_correction = bonferroni_correction,
    same_weekday_baseline = same_weekday_baseline
)
```

# create_topchart

```{r}
setup_config()
#debugonce(create_topchart)

# TEST OK avec topwords
topch1 <- create_topchart(topic = topic, serie = "topwords", country_codes=c(),date_min=date_min,date_max=date_max, with_retweets = FALSE, top = 25)

topch1r <- create_topchart(topic = topic, serie = "topwords", country_codes=c(),date_min=date_min,date_max=date_max, with_retweets = TRUE, top = 25)

# TEST OK avec tags
topch2 <- create_topchart(topic = topic, serie = "tags", country_codes=c(),date_min=date_min,date_max=date_max, with_retweets = FALSE, top = 25)

# TEST OK avec urls
topch3 <- create_topchart(topic = topic, serie = "urls", country_codes=c(),date_min=date_min,date_max=date_max, with_retweets = FALSE, top = 25)


# TEST OK avec tags + countries
topch4 <- create_topchart(topic = topic, serie = "tags", country_codes=c(3),date_min=date_min,date_max=date_max, with_retweets = FALSE, top = 25)

# Fails with a location: see with Francisco
 create_topchart(topic = topic, serie = "topwords", country_codes=c(4),date_min=date_min,date_max=date_max, with_retweets = FALSE, top = 25)
```

# create_map

```{r}
setup_config()
m1 <- create_map(topic = topic, countries = countries, date_min = date_min, date_max = date_max, with_retweets = FALSE)

m1r <- create_map(topic = topic, countries = countries, date_min = date_min, date_max = date_max, with_retweets = TRUE)

# test with some countries
countries <- 4
m2 <- create_map(topic = topic, countries = countries, date_min = date_min, date_max = date_max, with_retweets = TRUE)

countries <- 12
m2 <- create_map(topic = topic, countries = countries, date_min = date_min, date_max = date_max, with_retweets = TRUE)
```

```{r}
# raw <- epitweetr::get_aggregates("country_counts", filter = list(period = c(substr(as.character(Sys.Date() - 360), 1, 10), substr(as.character(Sys.Date()), 1, 10))), cache = F)

# agg <- tibble::tibble(
#     raw %>% dplyr::group_by(geo_country_code)
#         %>% dplyr::count() %>% dplyr::arrange(-n)
# )
# agg
# View(agg)
# original / quote : equivalent de original / retweet
```


